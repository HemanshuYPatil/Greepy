name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to publish (example: v0.1.2)"
        required: false
        type: string

jobs:
  publish-tauri:
    permissions:
      contents: write
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: ./src-tauri -> target

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prepare bundled Whisper resources
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $repoRoot = $PWD
          $workDir = Join-Path $env:RUNNER_TEMP "whispercpp"
          if (Test-Path $workDir) {
            Remove-Item -Recurse -Force $workDir
          }

          git clone --depth 1 https://github.com/ggml-org/whisper.cpp $workDir
          Push-Location $workDir
          $modelPath = Join-Path $workDir "models\ggml-tiny.en.bin"
          $downloadScript = Join-Path $workDir "models\download-ggml-model.cmd"
          if (Test-Path $downloadScript) {
            & $downloadScript tiny.en
          }
          if (-not (Test-Path $modelPath)) {
            Invoke-WebRequest -Uri "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.en.bin?download=true" -OutFile $modelPath
          }
          if (-not (Test-Path $modelPath)) {
            throw "Failed to fetch ggml-tiny.en.bin for release packaging."
          }
          if ((Get-Item $modelPath).Length -lt 1000000) {
            throw "Downloaded ggml-tiny.en.bin appears invalid (too small)."
          }
          cmake -S . -B build -A x64
          cmake --build build --config Release --target whisper-cli
          Pop-Location

          $resourceDir = Join-Path $repoRoot "src-tauri\resources\whisper"
          New-Item -ItemType Directory -Force -Path $resourceDir | Out-Null
          Copy-Item $modelPath (Join-Path $resourceDir "ggml-tiny.en.bin") -Force

          $cliCandidates = @(
            (Join-Path $workDir "build\bin\Release\whisper-cli.exe"),
            (Join-Path $workDir "build\bin\whisper-cli.exe")
          )
          $cliPath = $cliCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $cliPath) {
            throw "whisper-cli.exe was not produced by the whisper.cpp build."
          }
          Copy-Item $cliPath (Join-Path $resourceDir "whisper-cli.exe") -Force

          $cliDir = Split-Path -Parent $cliPath
          $runtimeDlls = Get-ChildItem -Path $cliDir -Filter "*.dll" -File -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -match "^(whisper|ggml.*)\.dll$" }
          foreach ($dll in $runtimeDlls) {
            Copy-Item $dll.FullName (Join-Path $resourceDir $dll.Name) -Force
          }
          if (-not $runtimeDlls) {
            Write-Host "No whisper/ggml runtime DLL sidecars found next to whisper-cli.exe; proceeding with current binary output."
          }

      - name: Build and publish release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: .
          tagName: ${{ github.event.inputs.tag || github.ref_name }}
          releaseName: Greepy ${{ github.event.inputs.tag || github.ref_name }}
          releaseBody: See release assets for installers and updater metadata.
          releaseDraft: false
          prerelease: false
